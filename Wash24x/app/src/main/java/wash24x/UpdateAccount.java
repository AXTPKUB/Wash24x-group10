package wash24x;

import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

public class UpdateAccount {

    // ‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ï‡∏£‡∏±‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    public UpdateAccount(Stage primaryStage, String username) {
        // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        Label titleLabel = new Label("üõ†Ô∏è Update Account");
        titleLabel.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥
        Label profileLabel = new Label("Select Profile:");
        ComboBox<String> profileComboBox = new ComboBox<>();
        profileComboBox.getItems().addAll("üòÄ", "üòé", "üê±", "üê∂", "üë§", "ü•∑", "üë®‚Äç‚úàÔ∏è", "üë®‚Äç‚öñÔ∏è",
                "üë®‚Äçüé®", "üë©‚Äçüé®", "üéÖ", "üëº", "ü§¥", "üë®‚Äçüî¨", "üë®‚Äçüíº",
                "üë®‚Äçüéì", "üë®‚Äçüç≥", "üë®‚Äçüåæ", "üßû‚Äç‚ôÇÔ∏è", "üßô‚Äç‚ôÇÔ∏è", "üßù‚Äç‚ôÄÔ∏è",
                "üßù‚Äç‚ôÇÔ∏è", "üßù", "üßõ‚Äç‚ôÇÔ∏è", "üßå", "üßú‚Äç‚ôÇÔ∏è", "üßü‚Äç‚ôÇÔ∏è", "üßü");
        profileComboBox.setValue(UserData.getUserProfile(username)); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

        // ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        Label nameLabel = new Label("New Username:");
        TextField nameField = new TextField(username);

        // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        Button changePasswordButton = new Button("Change Password");
        changePasswordButton.setOnAction(e -> new ChangePassword(primaryStage, username));

        // ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        Label passwordLabel = new Label("Enter Password to Confirm:");
        PasswordField passwordField = new PasswordField();

        // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        Button saveButton = new Button("Save Changes");
        saveButton.setOnAction(e -> {
            String oldUsername = UserData.getCurrentUsername(); // ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            String newProfile = profileComboBox.getValue();
            String newName = nameField.getText().trim();
            String password = passwordField.getText();

            // Debug Log
            System.out.println("Verifying password for: " + oldUsername);
            System.out.println("Entered Password: " + password);
            System.out.println("New Username: " + newName);
            System.out.println("New Profile: " + newProfile);

            boolean isProfileChanged = !newProfile.equals(UserData.getUserProfile(oldUsername));
            boolean isUsernameChanged = !newName.equals(oldUsername);

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
            if (!isProfileChanged && !isUsernameChanged) {
                new Alert(Alert.AlertType.INFORMATION, "No changes were made.").showAndWait();
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            if (isUsernameChanged && newName.isEmpty()) {
                new Alert(Alert.AlertType.ERROR, "Username cannot be empty!").showAndWait();
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isUsernameChanged && UserData.userExists(newName)) {
                new Alert(Alert.AlertType.ERROR, "Username already exists!").showAndWait();
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (UserData.verifyPassword(oldUsername, password)) {
                System.out.println("‚úÖ Password Verified!");

                try {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    if (isProfileChanged) {
                        UserData.updateProfile(oldUsername, newProfile);
                    }

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    if (isUsernameChanged) {
                        boolean success = UserData.updateUsername(oldUsername, newName);
                        if (!success)
                            throw new Exception("Failed to update username");
                    }

                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    UserData.setCurrentUsername(isUsernameChanged ? newName : oldUsername);
                    UserData.getUserProfile(newProfile);

                    System.out.println("Updated Username: " + UserData.getCurrentUsername());
                    System.out.println("Updated Profile: " + UserData.getCurrentUserProfile());

                    new Alert(Alert.AlertType.INFORMATION, "Account Updated Successfully!").showAndWait();

                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
                    primaryStage.setScene(new Scene(new window(primaryStage).getRoot(), 550, 550));
                } catch (Exception ex) {
                    System.err.println("Error updating account: " + ex.getMessage());
                    new Alert(Alert.AlertType.ERROR, "Error updating account: " + ex.getMessage()).showAndWait();
                }
            } else {
                System.out.println("‚ùå Password Incorrect!");
                new Alert(Alert.AlertType.ERROR, "Incorrect password!").showAndWait();
            }
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        Button backButton = new Button("‚Ü©Ô∏è Back");
        backButton.setOnAction(e -> new window(primaryStage));

        // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö UI ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
        VBox vbox = new VBox(10, titleLabel, profileLabel, profileComboBox, nameLabel, nameField,
                passwordLabel, passwordField, changePasswordButton, saveButton, backButton);
        vbox.setAlignment(Pos.CENTER);
        vbox.setPadding(new Insets(20));

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Scene ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Update Account
        Scene scene = new Scene(vbox, 400, 500);
        primaryStage.setScene(scene);
        primaryStage.show();
    }
}
